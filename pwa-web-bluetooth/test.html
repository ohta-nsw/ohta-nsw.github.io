<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Web Bluetooth è¨ºæ–­ãƒ„ãƒ¼ãƒ«</title>
  <style>
    body { 
      font-family: system-ui, -apple-system, sans-serif; 
      margin: 16px; 
      max-width: 600px;
    }
    button { 
      padding: 12px 20px; 
      margin: 8px 0; 
      font-size: 16px;
      width: 100%;
    }
    .status { 
      padding: 12px; 
      margin: 8px 0; 
      border-radius: 4px;
      font-weight: bold;
    }
    .ok { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .warning { background: #fff3cd; color: #856404; }
    pre { 
      background: #f5f5f5; 
      padding: 12px; 
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>ğŸ” Web Bluetooth è¨ºæ–­</h1>

  <div id="results"></div>

  <h2>Step 1: ç’°å¢ƒãƒã‚§ãƒƒã‚¯</h2>
  <button onclick="checkEnvironment()">ç’°å¢ƒã‚’è¨ºæ–­</button>

  <h2>Step 2: ãƒ‡ãƒã‚¤ã‚¹ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆç°¡æ˜“ç‰ˆï¼‰</h2>
  <p>ã™ã¹ã¦ã®BLEãƒ‡ãƒã‚¤ã‚¹ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¾ã™ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãªã—ï¼‰</p>
  <button onclick="scanAnyDevice()">ä»»æ„ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’ã‚¹ã‚­ãƒ£ãƒ³</button>

  <h2>Step 3: Battery Service ã‚¹ã‚­ãƒ£ãƒ³</h2>
  <p>Battery Service (0x180F) ã‚’æŒã¤ãƒ‡ãƒã‚¤ã‚¹ã‚’ã‚¹ã‚­ãƒ£ãƒ³</p>
  <button onclick="scanBatteryService()">Battery Serviceã§ã‚¹ã‚­ãƒ£ãƒ³</button>

  <h3>ãƒ­ã‚°</h3>
  <pre id="log"></pre>

  <script>
    const logEl = document.getElementById('log');
    const resultsEl = document.getElementById('results');

    function log(msg, isError = false) {
      const timestamp = new Date().toLocaleTimeString();
      const prefix = isError ? 'âŒ' : 'âœ“';
      const text = `[${timestamp}] ${prefix} ${msg}\n`;
      console.log(msg);
      logEl.textContent += text;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function addResult(title, status, message) {
      const div = document.createElement('div');
      div.className = `status ${status}`;
      div.innerHTML = `<strong>${title}:</strong> ${message}`;
      resultsEl.appendChild(div);
    }

    async function checkEnvironment() {
      resultsEl.innerHTML = '';
      log('=== ç’°å¢ƒè¨ºæ–­é–‹å§‹ ===');

      // 1. Web Bluetooth API ã‚µãƒãƒ¼ãƒˆ
      if ('bluetooth' in navigator) {
        addResult('Web Bluetooth API', 'ok', 'ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™');
        log('Web Bluetooth API: ã‚µãƒãƒ¼ãƒˆæ¸ˆã¿');
      } else {
        addResult('Web Bluetooth API', 'error', 'ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
        log('Web Bluetooth API: æœªã‚µãƒãƒ¼ãƒˆ', true);
        return;
      }

      // 2. Secure Context (HTTPS)
      if (window.isSecureContext) {
        addResult('Secure Context (HTTPS)', 'ok', 'HTTPSã§å‹•ä½œã—ã¦ã„ã¾ã™');
        log('Secure Context: OK');
      } else {
        addResult('Secure Context (HTTPS)', 'error', 'HTTPSãŒå¿…è¦ã§ã™');
        log('Secure Context: NG - HTTPSã§é…ä¿¡ã—ã¦ãã ã•ã„', true);
      }

      // 3. User Agent
      log(`User Agent: ${navigator.userAgent}`);

      // 4. Bluetooth availability ãƒã‚§ãƒƒã‚¯
      try {
        const available = await navigator.bluetooth.getAvailability();
        if (available) {
          addResult('Bluetooth åˆ©ç”¨å¯èƒ½æ€§', 'ok', 'BluetoothãŒåˆ©ç”¨å¯èƒ½ã§ã™');
          log('Bluetooth: åˆ©ç”¨å¯èƒ½');
        } else {
          addResult('Bluetooth åˆ©ç”¨å¯èƒ½æ€§', 'warning', 'BluetoothãŒç„¡åŠ¹ã¾ãŸã¯åˆ©ç”¨ä¸å¯');
          log('Bluetooth: ç„¡åŠ¹ - ãƒ‡ãƒã‚¤ã‚¹ã®Bluetoothè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„', true);
        }
      } catch (e) {
        addResult('Bluetooth åˆ©ç”¨å¯èƒ½æ€§', 'warning', 'ãƒã‚§ãƒƒã‚¯ã§ãã¾ã›ã‚“ã§ã—ãŸ');
        log(`Bluetooth availability check error: ${e.message}`);
      }

      // 5. æ¨©é™ãƒ’ãƒ³ãƒˆ
      addResult('æ¨©é™ã®ç¢ºèª', 'warning', 
        'Androidç«¯æœ«ã®å ´åˆ: è¨­å®šâ†’ã‚¢ãƒ—ãƒªâ†’Chromeâ†’æ¨©é™â†’ä½ç½®æƒ…å ±ã‚’ã€Œè¨±å¯ã€ã«ã—ã¦ãã ã•ã„');

      log('=== è¨ºæ–­å®Œäº† ===');
    }

    async function scanAnyDevice() {
      log('=== ä»»æ„ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’ã‚¹ã‚­ãƒ£ãƒ³ ===');
      try {
        log('ãƒ‡ãƒã‚¤ã‚¹é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºä¸­...');
        
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ['battery_service', 'device_information']
        });

        log(`âœ“ ãƒ‡ãƒã‚¤ã‚¹ãŒé¸æŠã•ã‚Œã¾ã—ãŸ: ${device.name || '(åç§°ãªã—)'} [${device.id}]`);
        addResult('ã‚¹ã‚­ãƒ£ãƒ³çµæœ', 'ok', `ãƒ‡ãƒã‚¤ã‚¹ã€Œ${device.name || '(åç§°ãªã—)'}ã€ã‚’æ¤œå‡ºã—ã¾ã—ãŸ`);

      } catch (e) {
        log(`âœ— ã‚¨ãƒ©ãƒ¼: ${e.name} - ${e.message}`, true);
        
        if (e.name === 'NotFoundError') {
          addResult('ã‚¹ã‚­ãƒ£ãƒ³çµæœ', 'warning', 'ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰');
        } else if (e.name === 'SecurityError') {
          addResult('ã‚¹ã‚­ãƒ£ãƒ³çµæœ', 'error', 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ©ãƒ¼ - HTTPSã¾ãŸã¯æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
        } else if (e.name === 'NotSupportedError') {
          addResult('ã‚¹ã‚­ãƒ£ãƒ³çµæœ', 'error', 'Web BluetoothãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“');
        } else {
          addResult('ã‚¹ã‚­ãƒ£ãƒ³çµæœ', 'error', `ã‚¨ãƒ©ãƒ¼: ${e.message}`);
        }
        
        console.error(e);
      }
    }

    async function scanBatteryService() {
      log('=== Battery Service (0x180F) ã§ã‚¹ã‚­ãƒ£ãƒ³ ===');
      try {
        log('ãƒ‡ãƒã‚¤ã‚¹é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºä¸­...');
        
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ services: ['battery_service'] }]
        });

        log(`âœ“ ãƒ‡ãƒã‚¤ã‚¹ãŒé¸æŠã•ã‚Œã¾ã—ãŸ: ${device.name || '(åç§°ãªã—)'}`);
        
        // æ¥ç¶šã—ã¦ã¿ã‚‹
        log('æ¥ç¶šä¸­...');
        const server = await device.gatt.connect();
        log('âœ“ æ¥ç¶šæˆåŠŸ');
        
        const service = await server.getPrimaryService('battery_service');
        log('âœ“ Battery Serviceå–å¾—æˆåŠŸ');
        
        const characteristic = await service.getCharacteristic('battery_level');
        log('âœ“ Battery Levelå–å¾—æˆåŠŸ');
        
        const value = await characteristic.readValue();
        const battery = value.getUint8(0);
        log(`âœ“ ãƒãƒƒãƒ†ãƒªãƒ¼ãƒ¬ãƒ™ãƒ«: ${battery}%`);
        
        addResult('Battery Service', 'ok', `ãƒãƒƒãƒ†ãƒªãƒ¼ãƒ¬ãƒ™ãƒ« ${battery}% ã‚’å–å¾—ã—ã¾ã—ãŸ`);
        
        device.gatt.disconnect();
        
      } catch (e) {
        log(`âœ— ã‚¨ãƒ©ãƒ¼: ${e.name} - ${e.message}`, true);
        addResult('Battery Service', 'error', `ã‚¨ãƒ©ãƒ¼: ${e.message}`);
        console.error(e);
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•è¨ºæ–­
    window.addEventListener('load', () => {
      log('è¨ºæ–­ãƒ„ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
      log('ã¾ãšã€Œç’°å¢ƒã‚’è¨ºæ–­ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„');
    });
  </script>
</body>
</html>
